apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules
  namespace: monitoring
data:
  alert-rules.yml: |
    groups:
      # ========================================
      # Alertes Application SouqTech
      # ========================================
      - name: souqtech-application
        rules:
          # Alerte si le backend est down
          - alert: BackendDown
            expr: up{job="spring-boot-app"} == 0
            for: 1m
            labels:
              severity: critical
              team: backend
            annotations:
              summary: "Backend SouqTech est DOWN"
              description: "Le backend Spring Boot n'est pas accessible depuis {{ $labels.instance }}"
              runbook_url: "https://wiki.souqtech.com/runbooks/backend-down"

          # Alerte si le temps de réponse est élevé
          - alert: HighResponseTime
            expr: histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket{application="souqtech-backend"}[5m])) by (le)) > 2
            for: 5m
            labels:
              severity: warning
              team: backend
            annotations:
              summary: "Temps de réponse élevé sur le backend"
              description: "Le 95ème percentile du temps de réponse est supérieur à 2 secondes"

          # Alerte si trop d'erreurs HTTP 5xx
          - alert: HighErrorRate
            expr: sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) / sum(rate(http_server_requests_seconds_count[5m])) > 0.05
            for: 5m
            labels:
              severity: critical
              team: backend
            annotations:
              summary: "Taux d'erreur HTTP 5xx élevé"
              description: "Plus de 5% des requêtes retournent des erreurs 5xx"

      # ========================================
      # Alertes JVM / Mémoire
      # ========================================
      - name: jvm-alerts
        rules:
          # Alerte si la mémoire heap est presque pleine
          - alert: JvmHeapMemoryHigh
            expr: (jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"}) * 100 > 85
            for: 5m
            labels:
              severity: warning
              team: backend
            annotations:
              summary: "Mémoire heap JVM élevée"
              description: "L'utilisation de la mémoire heap est à {{ $value | printf \"%.1f\" }}%"

          # Alerte si trop de garbage collection
          - alert: JvmGcTimeHigh
            expr: rate(jvm_gc_pause_seconds_sum[5m]) > 0.5
            for: 5m
            labels:
              severity: warning
              team: backend
            annotations:
              summary: "Temps de GC élevé"
              description: "Le garbage collector prend trop de temps ({{ $value | printf \"%.2f\" }}s/5min)"

      # ========================================
      # Alertes Base de données
      # ========================================
      - name: database-alerts
        rules:
          # Alerte si les connexions DB sont saturées
          - alert: DatabaseConnectionPoolExhausted
            expr: hikaricp_connections_active / hikaricp_connections_max > 0.8
            for: 5m
            labels:
              severity: warning
              team: backend
            annotations:
              summary: "Pool de connexions DB presque saturé"
              description: "{{ $value | printf \"%.0f\" }}% du pool de connexions est utilisé"

      # ========================================
      # Alertes Infrastructure Kubernetes
      # ========================================
      - name: kubernetes-alerts
        rules:
          # Alerte si un pod redémarre trop souvent
          - alert: PodRestartingTooMuch
            expr: increase(kube_pod_container_status_restarts_total[1h]) > 5
            for: 10m
            labels:
              severity: warning
              team: devops
            annotations:
              summary: "Pod {{ $labels.pod }} redémarre trop souvent"
              description: "Le pod {{ $labels.pod }} a redémarré {{ $value }} fois en 1 heure"

          # Alerte si Prometheus lui-même a des problèmes
          - alert: PrometheusTargetDown
            expr: up == 0
            for: 5m
            labels:
              severity: critical
              team: devops
            annotations:
              summary: "Target Prometheus {{ $labels.job }} est DOWN"
              description: "Le target {{ $labels.instance }} du job {{ $labels.job }} n'est pas accessible"
