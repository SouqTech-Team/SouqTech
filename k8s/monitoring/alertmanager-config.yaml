apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
      # Configuration SMTP pour Gmail
      # ‚ö†Ô∏è REMPLACEZ PAR VOS PROPRES CREDENTIALS
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_from: 'YOUR_EMAIL@gmail.com'
      smtp_auth_username: 'YOUR_EMAIL@gmail.com'
      smtp_auth_password: 'YOUR_APP_PASSWORD'
      smtp_require_tls: true

    # Route principale
    route:
      group_by: ['alertname', 'severity', 'namespace']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      receiver: 'default-receiver'
      
      routes:
        - match:
            severity: critical
          receiver: 'critical-receiver'
          continue: true
        - match:
            severity: warning
          receiver: 'warning-receiver'

    # Receivers
    receivers:
      - name: 'default-receiver'
        email_configs:
          - to: 'YOUR_EMAIL@gmail.com'
            send_resolved: true
            headers:
              Subject: 'üîî SouqTech Alert: {{ .Status | toUpper }}'
        discord_configs:
          - webhook_url: 'YOUR_DISCORD_WEBHOOK_URL'
            send_resolved: true
            title: '{{ if eq .Status "firing" }}üö® ALERTE{{ else }}‚úÖ R√âSOLUE{{ end }}'
            message: |
              {{ range .Alerts }}
              **{{ .Labels.alertname }}** - {{ .Labels.severity }}
              {{ .Annotations.summary }}
              {{ .Annotations.description }}
              {{ end }}

      - name: 'critical-receiver'
        email_configs:
          - to: 'YOUR_EMAIL@gmail.com'
            send_resolved: true
            headers:
              Subject: 'üö® CRITIQUE SouqTech: {{ if eq .Status "firing" }}FIRING{{ else }}RESOLVED{{ end }} - {{ .GroupLabels.alertname }}'
        discord_configs:
          - webhook_url: 'YOUR_DISCORD_WEBHOOK_URL'
            send_resolved: true
            title: '{{ if eq .Status "firing" }}üö® ALERTE CRITIQUE{{ else }}‚úÖ ALERTE R√âSOLUE{{ end }}'
            message: |
              {{ range .Alerts }}
              **{{ .Labels.alertname }}**
              Statut: {{ if eq .Status "firing" }}üî• EN COURS{{ else }}‚úÖ R√âTABLI{{ end }}
              S√©v√©rit√©: {{ .Labels.severity }}
              {{ .Annotations.summary }}
              {{ .Annotations.description }}
              {{ end }}

      - name: 'warning-receiver'
        email_configs:
          - to: 'YOUR_EMAIL@gmail.com'
            send_resolved: true
            headers:
              Subject: '‚ö†Ô∏è Warning SouqTech: {{ if eq .Status "firing" }}FIRING{{ else }}RESOLVED{{ end }} - {{ .GroupLabels.alertname }}'
        discord_configs:
          - webhook_url: 'YOUR_DISCORD_WEBHOOK_URL'
            send_resolved: true
            title: '{{ if eq .Status "firing" }}‚ö†Ô∏è AVERTISSEMENT{{ else }}‚úÖ R√âSOLU{{ end }}'
            message: |
              {{ range .Alerts }}
              **{{ .Labels.alertname }}**
              Statut: {{ if eq .Status "firing" }}‚è≥ ATTENTION{{ else }}‚úÖ OK{{ end }}
              {{ .Annotations.summary }}
              {{ end }}

    # R√®gles d'inhibition
    inhibit_rules:
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'namespace']
