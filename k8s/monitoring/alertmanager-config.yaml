apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
data:
  alertmanager.yml: |
    global:
      # Configuration globale
      resolve_timeout: 5m
      # Configuration SMTP pour les emails (√† personnaliser)
      # smtp_smarthost: 'smtp.gmail.com:587'
      # smtp_from: 'alertmanager@souqtech.com'
      # smtp_auth_username: 'your-email@gmail.com'
      # smtp_auth_password: 'your-app-password'

    # Route principale - d√©finit comment les alertes sont group√©es et envoy√©es
    route:
      # Grouper les alertes par ces labels
      group_by: ['alertname', 'severity', 'namespace']
      # Attendre 30 secondes avant d'envoyer la premi√®re notification
      group_wait: 30s
      # Attendre 5 minutes avant d'envoyer une mise √† jour du groupe
      group_interval: 5m
      # R√©p√©ter la notification toutes les 4 heures
      repeat_interval: 4h
      # Receiver par d√©faut
      receiver: 'default-receiver'
      
      # Routes sp√©cifiques selon la s√©v√©rit√©
      routes:
        - match:
            severity: critical
          receiver: 'critical-receiver'
          continue: true
        - match:
            severity: warning
          receiver: 'warning-receiver'

    # Configuration des receivers (destinataires des alertes)
    receivers:
      - name: 'default-receiver'
        # Webhook pour les logs (utile pour le debugging)
        webhook_configs:
          - url: 'http://localhost:5001/'
            send_resolved: true

      - name: 'critical-receiver'
        # Pour les alertes critiques - ajouter email, Slack, etc.
        webhook_configs:
          - url: 'http://localhost:5001/'
            send_resolved: true
        # Exemple Slack (d√©commenter et configurer):
        # slack_configs:
        #   - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        #     channel: '#alerts-critical'
        #     send_resolved: true
        #     title: 'üö® ALERTE CRITIQUE'
        #     text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'

      - name: 'warning-receiver'
        webhook_configs:
          - url: 'http://localhost:5001/'
            send_resolved: true

    # Templates pour les notifications (optionnel)
    templates: []

    # R√®gles d'inhibition - supprimer certaines alertes si d'autres sont d√©j√† actives
    inhibit_rules:
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'namespace']
